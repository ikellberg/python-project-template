---
name: code-review
description: Код-ревью изменений в коде. Сверяет с архитектурой проекта и требованиями (user story или issue). Используй когда просят сделать код-ревью, проверить реализацию, или упоминают "code review", "ревью кода", "проверить код".
---

# Code Review

Этот скилл проверяет код на соответствие архитектуре проекта и требованиям. Результат — конкретный фидбек для доработки.

## Вход

Пользователь запрашивает код-ревью, опционально указывая ID:
- "Сделай код-ревью US-001" — если есть user story
- "Сделай код-ревью ISS-001" — если есть issue
- "Сделай код-ревью" — без привязки к стори/issue

## Шаг 1: Пойми архитектуру проекта

**ОБЯЗАТЕЛЬНО** прочитай `project_state.md` — это база для любого ревью:
- Архитектура (модули, связи, потоки данных)
- Текущий спринт (что в работе)
- Done (что завершено)
- Грабли (неочевидные решения, которых нет в коде)

Без понимания архитектуры невозможно адекватно оценить код.

## Шаг 2: Получи контекст требований

Проверь запрос пользователя на наличие ID:
- **US-XXX** → прочитай `docs/user_stories.json`, найди `acceptanceCriteria`, `technicalNotes`, `relatedFiles`
- **ISS-XXX** → прочитай `docs/issues.json`, найди `description`, `technical_notes`, `type`
- **Нет ID** → пропусти этот шаг

## Шаг 3: Посмотри изменения

Выполни команды:

```bash
git status
git diff
```

Это покажет unstaged изменения — то, что написала другая LLM.

Если изменений нет или непонятно что смотреть — спроси у пользователя.

## Шаг 4: Прочитай изменённые файлы

Прочитай каждый изменённый файл целиком, чтобы понять контекст.

## Шаг 5: Проанализируй код

### Философия ревью

**Дай объективную оценку.** Каждое замечание должно быть фактом, а не интерпретацией.
- "Не реализован AC X" — факт (замечание)
- "Код мог бы быть лучше" — интерпретация (не замечание)

Разработчик отработает замечания: исправит или обоснует почему оставляет.

Лучше указать на потенциальную проблему, чем пропустить реальную.

### Чеклист проверки

**Соответствие требованиям (если был указан ID):**
- [ ] Каждый пункт AC или описания issue имеет прямое отражение в коде
- [ ] Изменения строго в рамках задачи (нет самовольного рефакторинга или overengineering-а)
- [ ] Затронуты только файлы, логически связанные с задачей

**Соответствие архитектуре (project_state.md) — ВСЕГДА:**
- [ ] Импорты и зависимости не нарушают слоистую архитектуру проекта
- [ ] Код переиспользует существующие модули вместо написания новых
- [ ] Паттерн совпадает с тем, что используется в аналогичных модулях

**Качество кода — ВСЕГДА:**
- [ ] Имена содержат термины предметной области (не data, temp, val)
- [ ] Конфигурационные параметры вынесены в константы/конфиги (не захардкожены)
- [ ] Нет магических чисел без пояснения
- [ ] Код соответствует стайлгайду проекта (если есть)

**Надёжность — ВСЕГДА:**
- [ ] Внешние вызовы (API, БД, файлы) обёрнуты в обработку ошибок
- [ ] Явно обработаны null, undefined, пустые массивы
- [ ] Типы данных корректны

**Безопасность — ВСЕГДА:**
- [ ] Нет секретов в коде (токены, пароли, ключи API)
- [ ] Входящие данные валидируются перед использованием

### Категории замечаний

При выводе замечаний указывай категорию:

**[БЛОКЕР]** — не выполнен AC/описание issue, баг, нарушение архитектуры, безопасность. Требует исправления.

**[ЗАМЕЧАНИЕ]** — качество кода, читаемость, edge cases, стиль. Разработчик должен рассмотреть и либо исправить, либо обосновать почему оставляет как есть.

## Шаг 6: Выдай результат

Выдай ревью в чат. Формат должен быть удобен для другой LLM, которая будет исправлять код.

### Структура ответа

1. **Заголовок** — ID и название (если есть) или краткое описание изменений
2. **Вердикт** — «Готов к коммиту» или «Требует доработки»
3. **Невыполненные требования** — только если был указан ID и есть невыполненные
4. **Замечания к коду** — пронумерованный список замечаний

**Формат одного замечания:**
- Категория: [БЛОКЕР] или [ЗАМЕЧАНИЕ]
- Файл и строка
- Что не так
- Сейчас (проблемный код)
- Нужно (как должно быть)
- Причина (почему это важно)

## Правила ревью

1. **Формат для LLM** — каждое замечание должно быть понятно без дополнительного контекста
2. **Файл + строка** — всегда указывай точное место
3. **Сейчас/Нужно** — покажи что есть и что должно быть
4. **Причина** — объясни почему
5. **Категория** — [БЛОКЕР] или [ЗАМЕЧАНИЕ] в начале каждого пункта

## Примеры

**Пользователь: "Сделай код-ревью US-002"**
1. Читаешь `project_state.md`
2. Видишь US-002 в запросе → читаешь `docs/user_stories.json`, находишь стори
3. Выполняешь `git status` и `git diff`
4. Читаешь изменённые файлы
5. Делаешь ревью
6. Выдаёшь ревью в чат

**Пользователь: "Сделай код-ревью ISS-001"**
1. Читаешь `project_state.md`
2. Видишь ISS-001 в запросе → читаешь `docs/issues.json`, находишь issue
3. Выполняешь `git status` и `git diff`
4. Читаешь изменённые файлы
5. Делаешь ревью
6. Выдаёшь ревью в чат

**Пользователь: "Сделай код-ревью изменений"**
1. Читаешь `project_state.md`
2. ID в запросе нет → пропускаешь чтение стори/issue
3. Выполняешь `git status` и `git diff`
4. Читаешь изменённые файлы
5. Делаешь ревью
6. Выдаёшь ревью в чат
