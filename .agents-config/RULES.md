# RULES

Базовые правила для всех проектов.

**Главный принцип:** Код должен быть простым, предсказуемым и понятным.

---

# ЧАСТЬ 1. БАЗОВЫЕ ПРАВИЛА

## 1. Качество кода
- Публичные функции с аннотациями типов.
- Современный синтаксис: `list[str]`, `str | None`. Запрещено: `List`, `Dict`, `Optional` из `typing`.
- Для структур данных и валидации — `Pydantic`. `dataclass` допустим для простых случаев без валидации.
- Работа с файлами: `pathlib.Path`, всегда `encoding="utf-8"`.
- Данные: числа — числа, отсутствие — `None`, без магических значений.

## 2. Читаемость
- Максимум 4 уровня вложенности.
- Guard clauses вместо вложенных `if`.
- Одна функция = одна ответственность.

## 3. Архитектура
- Запрещены абстракции "на будущее" (допустимы при 2+ реальных реализациях).
- I/O отдельно от бизнес-логики.
- Слои: `entrypoints` → `domain` → `infra`.

## 4. Работа с LLM
Принцип: **Dumb Pipe → Smart Reasoner → Deterministic Output**

- LLM принимает решения и генерирует текст, но не парсит и не валидирует.
- Входы/выходы LLM — Pydantic модели с явным контрактом.
- Формат ответа описан жёстко; поля "из головы" запрещены.
- Запрещено парсить ответ LLM регулярками.
- Если ответ невалиден — выбрасывать ошибку, не пытаться "угадать".

## 5. Ошибки и логи
- Валидация входов на границах системы.
- Ошибки не подавляются молча; `raise ... from e` сохраняет контекст.
- Логи через `logging`, без секретов; логи помогают восстановить цепочку событий.

## 6. Перед коммитом
- Линтер и тесты проходят.
- Нет закомментированного кода и временных костылей.
- TODO только с причиной.
- `.env.example` актуален (все переменные окружения, без секретов).

---

# ЧАСТЬ 2. ПРОЦЕСС РАЗРАБОТКИ

## 1. Коммуникация
- Если решение неочевидно — объясни перед написанием кода.
- Объяснения понятны человеку без бэкграунда разработки.
- Если архитектура усложняется — остановись и предложи упрощение.

## 2. Цикл планирования
1. Подготовка плана
2. Ревью плана
3. Доработка плана по замечаниям
4. Только после утверждения — переход к разработке

## 3. Цикл разработки
1. Реализация
2. Код-ревью
3. Ответ на замечания и правки
4. Тестирование → приёмка задачи
5. Обновить файл project_state.md

## 4. Ревью
- Критически оценивать каждое замечание, не выполнять слепо.
- Отклонять некорректные или избыточные замечания с обоснованием.
- Спорные моменты обсудить с пользователем перед внесением изменений.
- Автор несёт ответственность за финальное решение (с учётом мнения пользователя).

## 5. Стоп-кран
- 3 неудачные попытки исправить ошибку — **СТОП**.
- Не писать код дальше. Проанализировать, предложить другой подход.

## 6. project_state.md

Файл `project_state.md` в корне проекта — слепок состояния для быстрого погружения LLM в начале сессии.

Обязательные разделы:
- **Архитектура** — актуальная верхнеуровневая схема системы: основные модули, их связи и поток данных между ними
- **Текущий спринт** — что в работе прямо сейчас
- **Backlog** — приоритетный список (ID + название, без деталей)
- **Done** — компактно (диапазон или одна строка на этап)
- **Грабли** — грабли и неочевидные решения, которых нет в коде. К каждой строке — краткое пояснение ПОЧЕМУ так сделано. Не превращать в длинные объяснения или абзацы.

Правила:
- Обновляется после каждой завершённой задачи
- Не дублировать PRD, `docs/stories/`, структуру файлов
- Минимум текста — только то, что нельзя получить из кода или других docs
