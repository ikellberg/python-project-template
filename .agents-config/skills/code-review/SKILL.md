---
name: code-review
description: Код-ревью изменений в коде. Сверяет с архитектурой проекта и требованиями (user story или issue). Используй когда просят сделать код-ревью, проверить реализацию, или упоминают "code review", "ревью кода", "проверить код".
---

# Code Review

Этот скилл проверяет код на соответствие архитектуре проекта и требованиям. Результат — конкретный фидбек для доработки.

## Вход

Пользователь запрашивает код-ревью, опционально указывая ID:
- "Сделай код-ревью US-001" — если есть user story
- "Сделай код-ревью ISS-001" — если есть issue
- "Сделай код-ревью изменений" — без привязки к стори/issue

## Шаг 1: Пойми архитектуру проекта

**ОБЯЗАТЕЛЬНО** прочитай `project_state.md` — это база для любого ревью:
- Архитектура (модули, связи, потоки данных)
- Текущий спринт (что в работе)
- Done (что завершено)
- Грабли (неочевидные решения, которых нет в коде)

Без понимания архитектуры невозможно адекватно оценить код.

## Шаг 2: Получи контекст требований

Проверь запрос пользователя на наличие ID:
- **US-XXX** → прочитай `docs/stories/US-XXX.md` (или `docs/stories/done/US-XXX.md`), найди Acceptance Criteria, Technical Notes, Related Files
- **ISS-XXX** → прочитай `docs/issues/ISS-XXX.md` (или `docs/issues/done/ISS-XXX.md`), найди Description, Technical Notes, Type
- **Нет ID** → пропусти этот шаг

## Шаг 3: Посмотри изменения

Выполни команды:

```bash
git status
git diff
```

Это покажет unstaged изменения — то, что написала другая LLM.

Если изменений нет или непонятно что смотреть — спроси у пользователя.

## Шаг 4: Прочитай изменённые файлы

Прочитай каждый изменённый файл целиком, чтобы понять контекст.

## Шаг 5: Проанализируй код

### Философия ревью

**Дай объективную оценку.** Каждое замечание должно быть фактом, а не интерпретацией.
- "Не реализован AC X" — факт (замечание)
- "Код мог бы быть лучше" — интерпретация (не замечание)

Разработчик отработает замечания: исправит или обоснует почему оставляет.

Лучше указать на потенциальную проблему, чем пропустить реальную.

### Чеклист проверки

**Соответствие требованиям (если был указан ID):**
- [ ] Каждый пункт AC или описания issue имеет прямое отражение в коде
- [ ] Изменения строго в рамках задачи (нет самовольного рефакторинга или overengineering-а)
- [ ] Затронуты только файлы, логически связанные с задачей

**Соответствие архитектуре (project_state.md) — ВСЕГДА:**
- [ ] Импорты и зависимости не нарушают слоистую архитектуру проекта
- [ ] Код переиспользует существующие модули вместо написания новых
- [ ] Паттерн совпадает с тем, что используется в аналогичных модулях

**Качество кода — ВСЕГДА:**
- [ ] Имена содержат термины предметной области (не data, temp, val)
- [ ] Конфигурационные параметры вынесены в константы/конфиги (не захардкожены)
- [ ] Нет магических чисел без пояснения
- [ ] Код соответствует стайлгайду проекта (если есть)

**Надёжность — ВСЕГДА:**
- [ ] Внешние вызовы (API, БД, файлы) обёрнуты в обработку ошибок
- [ ] Явно обработаны null, undefined, пустые массивы
- [ ] Типы данных корректны

**Безопасность — ВСЕГДА:**
- [ ] Нет секретов в коде (токены, пароли, ключи API)
- [ ] Входящие данные валидируются перед использованием

### Категории замечаний

При выводе замечаний указывай категорию:

**[БЛОКЕР]** — не выполнен AC/описание issue, баг, нарушение архитектуры, безопасность. Требует исправления.

**[ЗАМЕЧАНИЕ]** — качество кода, читаемость, edge cases, стиль. Разработчик должен рассмотреть и либо исправить, либо обосновать почему оставляет как есть.

## Шаг 6: Сохрани ревью в файл

**ОБЯЗАТЕЛЬНО** сохрани результат ревью в файл. Путь зависит от ID в запросе:

- **US-XXX** → `docs/reviews/US-XXX-code-review.md`
- **ISS-XXX** → `docs/reviews/ISS-XXX-code-review.md`
- **Нет ID** → `docs/reviews/code-review-{slug}-YYYY-MM-DD.md` — придумай короткий slug по сути изменений (например: `summary-ui`, `excel-export`, `upload-flow`)

Результат будет передан другой LLM для доработки. Формат должен быть удобен для машинной обработки.

### Формат файла

```markdown
## Код-ревью: [ID или описание] — [название]

### Вердикт: [Готов к коммиту / Требует доработки]

### Невыполненные требования

(Только если был ID и есть невыполненные AC/описание issue. Иначе — пропусти секцию)

- **AC/Требование: "[текст]"** — не реализовано. [Что не так].

### Замечания к коду

1. **[БЛОКЕР/ЗАМЕЧАНИЕ]** **[Файл], строка [N]**: [Что не так]
   - Сейчас: `[проблемный код или описание]`
   - Нужно: `[как должно быть]`
   - Причина: [почему это важно]

2. **[БЛОКЕР/ЗАМЕЧАНИЕ]** **[Файл], строка [N]**: [...]
```

## Шаг 7: Сообщи пользователю

Выдай в чат кратко:
- **Путь к файлу** — `docs/reviews/...`
- **Вердикт** — «Готов к коммиту» или «Требует доработки»
- **Блокеры** — по одному в строку, суть в 5–10 слов: «не реализован AC X», «секрет в коде», «нарушение архитектуры»
- **Замечания** — то же: «магическое число в строке N», «имя переменной data»

Полное ревью — в файле.

## Правила ревью

1. **Формат для LLM** — каждое замечание должно быть понятно без дополнительного контекста
2. **Файл + строка** — всегда указывай точное место
3. **Сейчас/Нужно** — покажи что есть и что должно быть
4. **Причина** — объясни почему
5. **Категория** — [БЛОКЕР] или [ЗАМЕЧАНИЕ] в начале каждого пункта

## Примеры

**Пользователь: "Сделай код-ревью US-002"**
1. Читаешь `project_state.md`
2. Видишь US-002 в запросе → читаешь `docs/stories/US-002.md` (или `docs/stories/done/US-002.md`)
3. Выполняешь `git status` и `git diff`
4. Читаешь изменённые файлы
5. Делаешь ревью
6. Сохраняешь в `docs/reviews/US-002-code-review.md`
7. Сообщаешь путь, вердикт, блокеры и замечания по сути (кратко)

**Пользователь: "Сделай код-ревью ISS-001"**
1. Читаешь `project_state.md`
2. Видишь ISS-001 в запросе → читаешь `docs/issues/ISS-001.md`
3. Выполняешь `git status` и `git diff`
4. Читаешь изменённые файлы
5. Делаешь ревью
6. Сохраняешь в `docs/reviews/ISS-001-code-review.md`
7. Сообщаешь путь, вердикт, блокеры и замечания по сути (кратко)

**Пользователь: "Сделай код-ревью изменений"**
1. Читаешь `project_state.md`
2. ID в запросе нет → пропускаешь чтение стори/issue
3. Выполняешь `git status` и `git diff`
4. Читаешь изменённые файлы
5. Делаешь ревью
6. Сохраняешь в `docs/reviews/code-review-{slug}-YYYY-MM-DD.md` (slug по сути изменений)
7. Сообщаешь путь, вердикт, блокеры и замечания по сути (кратко)
